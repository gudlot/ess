name: Deploy

on:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      conda_label: ${{ startsWith(github.ref, 'refs/tags/') && 'main' || 'dev' }}
    steps:
      - uses: actions/checkout@v2  # Need to checkout repo so github-pages-deploy-action works
      - uses: actions/download-artifact@v2
      - uses: conda-incubator/setup-miniconda@v2
      - shell: bash -l {0}
        run: |
          conda install -c conda-forge --yes anaconda-client
          anaconda --token ${{ secrets.ANACONDATOKEN }} upload --user scipp --label ${{ env.conda_label }} $(ls conda-package-*/*/*.tar.bz2)

      - uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          branch: gh-pages
          folder: DocumentationHTML
          # Note: If this is a release, it will not deploy to the top level folder.
          # The next scheduled main build will update that.
          target-folder: ${{ env.conda_label == 'main' && format('release/{0}', github.ref_name) || '' }}
          single-commit: true
          clean-exclude: release
